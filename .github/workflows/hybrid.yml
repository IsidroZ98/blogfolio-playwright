name: Hybrid CI

on:
  push:
  pull_request:

permissions:
  contents: read
  actions: read
  checks: read


defaults:
  run:
    shell: bash

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:


  lint:
    name: Lint (Cloud)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm install
      - run: npm run lint

  unit_tests:
    name: Unit Tests (Cloud)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm install
      - run: npm test


  mac_build:
    name: macOS Build (Self-hosted Mac)
    runs-on: [self-hosted, macos]
    needs: [lint, unit_tests]

    
    if: github.event.pull_request.head.repo.fork == false

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew update
          brew install unzip wget allure || true

      - run: echo "Running macOS build..."
      - run: make build


  linux_build:
    name: Linux Build (Self-hosted Linux)
    runs-on: [self-hosted, linux]
    needs: [lint, unit_tests]

    if: github.event.pull_request.head.repo.fork == false

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies (Ubuntu, Arch, Mac)
        run: |
          echo "Runner OS: $RUNNER_OS"

          if command -v pacman >/dev/null 2>&1; then
            echo "Arch Linux detected"
            sudo pacman -Syu --noconfirm
            sudo pacman -S --noconfirm unzip wget
          elif command -v apt >/dev/null 2>&1; then
            echo "Ubuntu detected"
            sudo apt update
            sudo apt install -y unzip wget
          fi

      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip
          unzip allure-2.29.0.zip -d /opt/allure
          sudo ln -sf /opt/allure/allure-2.29.0/bin/allure /usr/local/bin/allure

      - run: echo "Running Linux build..."
      - run: make build-linux


  dashboard:
    name: CI Dashboard
    runs-on: ubuntu-latest
    needs: [lint, unit_tests, mac_build, linux_build]

    steps:
      - uses: actions/checkout@v4
      - name: Generate Dashboard
        run: |
          echo "## CI Dashboard" > dashboard.md
          echo "- Lint: ${{ needs.lint.result }}" >> dashboard.md
          echo "- Unit Tests: ${{ needs.unit_tests.result }}" >> dashboard.md
          echo "- macOS Build (Self-hosted): ${{ needs.mac_build.result }}" >> dashboard.md
          echo "- Linux Build (Self-hosted): ${{ needs.linux_build.result }}" >> dashboard.md

      - name: Upload Dashboard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-dashboard
          path: dashboard.md
